/*!
 * project : goods
 * author : LINOFFICE
 * N샵
 */ let goods_singleton=null,goods_singletonEnforcer="singletonEnforcer";class Goods{constructor(s){if(s!==goods_singletonEnforcer)throw"Cannot--construct singleton";this.init()}static get instance(){return goods_singleton||(goods_singleton=new Goods(goods_singletonEnforcer)),goods_singleton}init(){let s=this;s.searchPanel=$("#MenuWrap #searchPanel"),s.searchForm=document.searchForm,s.searchInput=s.searchPanel.find("#SearchInput"),s.menu_btn=document.querySelector(".myshop.btn_menu"),s.menu_span=document.querySelector(".myshop.btn_menu span"),s.menu_area=document.querySelector(".user_area .menu_area"),s.goods={item:null,price_type:null,price:0,saved_point:0,total_price:0,total_count:1},s.goods_sync=!1,s.searchInput.val(query||"룸티스의 귀걸이"),s.addEvents()}list(){let s=this;s.goods_list=null,s.goods_date_list=[],s.calc_timer=null;let e=moment(),a=function(a){if(!a||!a.start_date&&!a.finish_date)return"";if(a.start_date){let t=moment(new Date(a.start_date)),o=e.isSameOrAfter(t);if(!o)return s.goods_date_list.push(a),`<span class="msg_area"><span class="msg">${t.format("판매 시작 - DD일 HH : mm ~")}</span></span>`}if(a.finish_date){let n=moment(new Date(a.finish_date)),i=e.isBefore(n);if(!i)return`<span class="msg_area"><span class="msg">판매 기간 종료</span></span>`;let l=n.diff(e,"days"),c=n.diff(e,"hours")%24,r=n.diff(e,"minutes")%60;return s.goods_date_list.push(a),`<span class="msg_area"><span class="msg">기간 한정 - ${l}일 ${c<10?"0":""}${c} : ${r<10?"0":""}${r}</span></span>`}return""},t=function(){if(!s.goods_date_list){clearInterval(s.calc_timer);return}let e=moment(),a=[];if($.each(s.goods_date_list,function(s,t){let o=$("[data-id="+t.id+"]").find(".msg_area");if(t.start_date){let n=moment(new Date(t.start_date));if(!e.isSameOrAfter(n))return!0;if(!t.finish_date)return a.push(t),o.remove(),!0}if(!t.finish_date)return!0;let i=moment(new Date(t.finish_date));if(!e.isBefore(i))return a.push(t),o.find(".msg").text("판매 기간 종료"),!0;let l=i.diff(e,"days"),c=i.diff(e,"hours")%24,r=i.diff(e,"minutes")%60;o.find(".msg").text(`기간 한정 - ${l}일 ${c<10?"0":""}${c} : ${r<10?"0":""}${r}`)}),a.length)for(var t=0;t<a.length;t++)for(var o=0;o<s.goods_date_list.length;o++)a[t].id==s.goods_date_list[o].id&&s.goods_date_list.splice(o,1)},o=function(){s.goods_date_list&&(s.calc_timer=setInterval(t,6e4))};s.container=$(".pagination-container"),s.container.pagination({dataSource:function(s){getDatasWithOption([{type:"POST",url:"/define/goods",dataType:"json",contentType:"application/json",Accept:"application/json",data:{query:query}}],e=>{s(e)},s=>{console.log("fail data goods list")})},pageSize:18,showPrevious:!1,showNext:!1,showPageNumbers:!0,callback:function(e,t){let n="";e.length?(s.goods_list=e,n=s.goods_list.map((s,e)=>{let t=s[0];return`<div class="sub_card"><div class="box" data-id="${t.id}"><a href="#" class="lnk_detail">${a(t)}${t.flagTag_1}<div class="img_area"><img src="${t.icon_image}" alt="" class="item_img"></div><div class="item_info"><div class="v_align"><div class="tit_area"><em class="tit">${t.title}</em></div><div class="coin_area">${"NCOIN"===t.price_type?'<span class="ncoin">':'<span class="npoint">'}${commaAdd(t.price)}</span></div></div></div></a><div class="btn_area"><a href="" class="btn direct fn_orderform">${s.length>1?`구매`:`바로구매`}</a></div></div></div>`}).join(""),o()):n='<div class="search_not_found"><em>검색결과가 없습니다.</em><p>검색어의 철자가 정확한지 확인해주세요.<br> 검색어가 두 단어 이상일 경우, 띄어쓰기를 확인해주세요.</p></div>',$(".data-loader").css("display","none"),$("#ContentWrap .sub_wrap").html(n),$("#ContentWrap .sub_wrap .box > a.lnk_detail").on("click",function(s){urlform(`${$(this).closest(".box").attr("data-id")}`,"post","/goods/view"),eventStop(s)}),$("#ContentWrap .sub_wrap .box .btn_area > a").on("click",function(e){if("바로구매"===$(this).text()){let a=$(this).closest(".box").attr("data-id");s.goods.item=s.goods_list.find(s=>s[0].id==a)[0],s.goods.price_type=s.goods.item?s.goods.item.price_type:null,s.goods.total_price=s.goods.item?s.goods.item.price:0,s.buy_confirm()}else urlform(`${$(this).closest(".box").attr("data-id")}`,"post","/goods/view");eventStop(e)})}}),s.container.addHook("beforePageOnClick",function(s,e){current_page_number=e}),s.container.addHook("afterInit",function(e){let a=JSON.parse(getSession("PAGINATION_INFINITE_LIST"));if(a&&"goods"==a.page_type){current_page_number=a.page_number;let t=a.scroll_Y;current_page_number>1&&s.container.pagination("go",current_page_number),t>0&&window.scrollTo(0,t)}removeSession("PAGINATION_INFINITE_LIST")})}view(){let s=this;s.goods.item=goods_items[0],s.goods.price_type=s.goods.item.price_type,s.goods.price=s.goods.item.price,s.goods.saved_point=s.goods.item.saved_point,s.goods.total_price=s.goods.item.price,s.wrap_info=document.querySelector("#ContentWrap .goods_wrap .goods_info"),s.wrap_info.innerHTML=`${s.goods.item.flagTag_2?s.goods.item.flagTag_2:""}<h2 class="tit">${s.goods.item.title}</h2><div class="thumb"><img src="${s.goods.item.icon_image}" alt=""></div>`,s.wrap_sub=document.querySelector("#ContentWrap .goods_wrap .goods_sub");let e=`<div class="cell"><div class="box"><h4>아이템정보</h4><div class="info"><dl class="row"><dt>판매금액</dt><dd><span class="${s.goods.price_type.toLowerCase()}">${s.goods.item.price_comma}</span></dd></dl><dl class="row"><dt>상세정보</dt><dd><p class="desc">${s.goods.item.iteminfo}</p></dd></dl>${s.goods.item.date_tag}</div></div></div><div class="cell"><div class="box"><h4>합계금액</h4><div class="option_box" id="optionBox"><div class="option_info item"><div class="option_tit"><span class="tit" id="itemTitle">${s.goods.item.select_option_tag}</span><span class="v_align order_count counterWrap"><button type="button" class="count_btn down minus">수량 감소</button><input type="text" id="singleGoodsCount" class="count count_num counter" value="1" maxlength="2" style="ime-mode: disabled;" readonly><button type="button" class="count_btn up plus">수량 증가</button></span></div></div></div><div class="info price"><dl class="row"><dt>총 결제예정 금액</dt><dd><span class="item_price ${s.goods.price_type.toLowerCase()}" id="itemPrice">${s.goods.item.price_comma}</span></dd></dl>${s.goods.saved_point?`<dl class="row"><dt>총 적립예정 포인트</dt><dd><span class="npoint" id="rewardAmount">${s.goods.item.saved_point_comma}</span></dd></dl>`:""}</div><div class="btn_area"><div class="order_area"><div class="btn_bx"><a href="#" id="buyBtn" class="btn buy fn_orderform">구매</a></div></div></div></div></div>`;s.wrap_sub.innerHTML=e,$("#ContentWrap .goods_detail .detail_content .item_table").prepend(s.goods.item.detail_tag),s.count_down_btn=document.querySelector(".cell .box .counterWrap .count_btn.down"),s.count_up_btn=document.querySelector(".cell .box .counterWrap .count_btn.up"),s.count_down_btn.addEventListener("click",e=>{s.count_setting(-1)}),s.count_up_btn.addEventListener("click",e=>{s.count_setting(1)}),document.querySelector(".cell .box .btn_area .order_area .btn_bx #buyBtn").addEventListener("click",e=>{let a=$('.goods_option input[name="goods_select"]:checked').val();a&&(s.goods.item=goods_items.find(s=>s.itemid==a)),s.buy_confirm(),eventStop(e)})}count_setting(s){let e=this;if(!e.goods.item)return;let a=$(".cell .box"),t=a.find(".count_num"),o=Number(t.val());if(o<=1&&-1==s){popupShow("최소 구매 수량은 1개 입니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}if(o>=e.goods.item.limitCount&&1==s){popupShow(`최대 구매 수량은 ${e.goods.item.limitCount}개 입니다.`,'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}let n=o+s,i=e.goods.item.price*n;t.val(n),a.find("#itemPrice").text(commaAdd(i)),e.goods.total_count=n,e.goods.total_price=i,e.goods.saved_point&&a.find("#rewardAmount").text(commaAdd(e.goods.saved_point*n))}buy_confirm(){if(!account){popupShow("로그인 후 이용 가능합니다.</br>로그인 하시겠습니까?",'<span class="type2"><a href="javascript:login();" class="close">예</a></span>','<span class="type1"><a href="javascript:popupClose();" class="close">아니오</a></span>');return}if(!account.firstChar){popupShow("대표 캐릭터가 설정되어 있지 않습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}if(!this.goods.item){popupShow("구매할 상품을 선택해주십시오.",'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}if("NCOIN"===this.goods.price_type&&account.ncoin<this.goods.total_price){popupShow("N코인이 부족합니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}if("NPOINT"===this.goods.price_type&&account.npoint<this.goods.total_price){popupShow("N포인트가 부족합니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}popupShow("정말로 구매하시겠습니까?",`<span class="type2"><a href="javascript:goods_singleton.do_goods_buy();" class="close">예</a></span>`,'<span class="type1"><a href="javascript:popupClose();" class="close">아니오</a></span>')}do_goods_buy(){let s=this;if(!s.goods.item){popupShow("구매 상품을 발견하지 못했습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">확인</a></span>',null);return}if(s.goods_sync)return;s.goods_sync=!0;let e={id:s.goods.item.id,item_id:s.goods.item.itemid,buy_count:s.goods.total_count};getDatasWithOption([{type:"POST",url:"/define/goods/buy",dataType:"json",contentType:"application/json",Accept:"application/json",data:e}],e=>{switch(e){case 1:popupShow("구매가 완료되었습니다.</br></br>부가아이템창고에서</br>확인하시기 바랍니다.",'<span class="type2"><a href="javascript:popupCloseReload();" class="close">닫기</a></span>',null);break;case 2:popupShow("인게임에서 구매할 수 있습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 3:popupShow("계정 정보를 찾을 수 없습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 4:popupShow("대표 캐릭터가 설정되어 있지 않습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 5:popupShow("월드 내 캐릭터를 찾을 수 없습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 6:popupShow("존재하지 않는 아이템입니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 7:popupShow("Ncoin이 부족합니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 8:popupShow("Npoint가 부족합니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 9:popupShow("판매 가능한 시간이 아닙니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 10:popupShow("구매 제한 아이템은 1개씩 구매할 수 있습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;case 11:popupShow("구매 제한 횟수가 초과되었습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null);break;default:popupShow("구매에 실패하였습니다.",'<span class="type2"><a href="javascript:popupClose();" class="close">닫기</a></span>',null)}s.goods_sync=!1},e=>{s.goods_sync=!1})}show_menu(){let s=this;s.menu_btn.classList.add("on"),s.menu_span.innerText="접기",s.menu_area.style.display="block"}hide_menu(){let s=this;s.menu_btn.classList.remove("on"),s.menu_span.innerText="마이N샵",s.menu_area.style.display="none"}addEvents(){let s=this;s.searchBtn=s.searchPanel.find(".btn_search"),s.searchResetBtn=$("#MenuWrap .gnb .btn_area .btn_reset"),s.searchInput.focus(function(){$(this).addClass("on"),$(this).val("")}),s.searchResetBtn.on("click",function(e){s.searchInput.val(""),s.searchInput.focus()}),s.searchBtn.click(function(){s.searchForm.query.value||(s.searchForm.query.value=""),s.searchForm.submit()}),s.menu_btn&&s.menu_btn.addEventListener("click",e=>{s.menu_btn.classList.contains("on")?s.hide_menu():s.show_menu()}),$("body").mouseup(function(e){let a=e.target;!s.searchInput.has(a).length&&!s.searchPanel.has(a).length&&s.searchInput.hasClass("on")&&s.searchInput.removeClass("on"),!s.menu_btn||s.menu_area.contains(a)||s.menu_btn.contains(a)||s.hide_menu(),eventStop(e)})}}