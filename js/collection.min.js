/*!
 * project : collection
 * author : LINOFFICE
 * 아이템 컬렉션
 */ let tab_type,total_size=0,current_size=0;$(function(){tab_type||(tab_type="ALL"),create_category(),$(".btn_close").on("click",function(t){window.self.opener?window.self.close():history.back()}),$(".btn_reload").on("click",function(t){location.reload()}),render_list(collections),$(".scrollbar-macosx").scrollbar()});const CATEGORY_DESCS={ALL:"전체",NORMAL:"일반",ADVANCED:"고급",RARE:"희귀",HERO:"영웅",LEGEND:"전설",MYTH:"신화",ONLY:"유일",EVENT:"이벤트",LEVEL:"레벨"};function create_category(){if(!collections)return;let t=100/(collections.length+1),e="",s=0;for(var i=0;i<collections.length;i++){let l=collections[i],n=l.section_list?l.section_list.length:0;s+=n;e+=`<li style="width: ${t}%;"><a href="javascript:change_tab('${l.category}')" data-value="${l.category}" class="${tab_type==l.category?"on":""}">${CATEGORY_DESCS[l.category]}(${n})</a></li>`}$("#collectionTab .handle .btns").html(`<li style="width: ${t}%;"><a href="javascript:change_tab('ALL')" data-value="ALL" class="${"ALL"==tab_type?"on":""}">전체(${s})</a></li>${e}`)}function change_tab(t){if(tab_type!=t){if($("#collectionTab .btns > li > a").removeClass("on"),$("#collectionTab .btns > li > a[data-value="+t+"]").addClass("on"),"ALL"==(tab_type=t))render_list(collections);else{let e=[];for(var s=0;s<collections.length;s++)collections[s].category==tab_type&&e.push(collections[s]);render_list(e)}$(".scrollbar-macosx").scrollbar()}}function get_slot(t,e,s){if(!collections)return null;for(var i=0;i<collections.length;i++){let l=collections[i];if(l.category==t)for(var n=0;n<l.section_list.length;n++){let o=l.section_list[n];if(o.section_id==e)for(var a=0;a<o.slot_list.length;a++){let c=o.slot_list[a];if(c.slot_id==s)return c}}}return null}function get_slot_desc(t){let e="";return 1!=t.bless&&(e+=`<i class="${0==t.bless?"blessed":"cursed"}">`),t.enchant>0&&(e+=`+${t.enchant} `),e+=t.item.name,t.amount>1&&(e+=` (${commaAdd(t.amount)})`),1!=t.bless&&(e+="</i>"),e}function get_inventory_item(t){if(!inventory)return null;for(var e=0;e<inventory.length;e++){let s=inventory[e];if(s.item_id==t.item.itemid&&s.amount>=t.amount&&s.enchant==t.enchant&&s.bless==t.bless)return s}return null}function get_regist(t,e){if(!regist||!regist.regist_list)return null;for(var s=0;s<regist.regist_list.length;s++){let i=regist.regist_list[s];if(i.category==t&&i.section_id==e)return i}return null}function get_section_status_html(t){return t&&t.is_complete?'<strong class="section_complete">완성</strong>':""}function get_slot_status(t,e,s){if(e&&e.slot_list&&e.slot_list.length)for(var i=0;i<e.slot_list.length;i++){let l=e.slot_list[i];if(l.slot_id==t.slot_id&&l.item.itemid==t.item.itemid&&l.amount==t.amount&&l.enchant==t.enchant&&l.bless==t.bless)return 1}return s?2:0}function get_slot_status_html(t,e,s,i,l){switch(t){case 0:return'<div class="status disable"></div>';case 2:return`<div class="status enable"><button onClick="confirm_regist('${e}', ${s}, ${i}, ${l.id});">등록</button></div>`;default:return""}}function section_top_click(t){$(t).parent(".collection_section").toggleClass("up")}function render_list(t){$(".data-loader").css("display","block");let e="";if(t.length>0){total_size=current_size=0,e+='<ul id="collection_list">',$.each(t,function(t,s){s.section_list&&s.section_list.length&&$.each(s.section_list,function(t,i){let l=get_regist(s.category,i.section_id),n=get_section_status_html(l);total_size++,""!=n&&current_size++,e+=`<li class="collection_section" data-category="${s.category}" data-section-id="${i.section_id}"><div class="top" onClick="section_top_click(this);"><div class="section_desc"><strong>${i.section_desc}</strong>${n}</div><div class="bonus_desc"><div class="scrollbar-macosx"><ul>${i.bonus_desc}</ul></div></div></div><div class="slot_list">`,i.slot_list&&i.slot_list.length&&(e+="<ul>",$.each(i.slot_list,function(t,n){let o=get_inventory_item(n),a;e+=`<li class="slot" style="background-image : url('/img/item/${n.item.icon_id}.png');" data-category="${s.category}" data-section-id="${i.section_id}" data-slot-id="${n.slot_id}">${get_slot_status_html(get_slot_status(n,l,o),s.category,i.section_id,n.slot_id,o)}<strong class="slot_desc">${get_slot_desc(n)}</strong></li>`}),e+="</ul>"),e+="</div></li>"})}),e+="</ul>";let s=`완성률(${current_size}/${total_size} ${Math.max(Math.min(parseInt(current_size/total_size*100),100),0)}%)`;$("header h1 span").text(s)}else e=`<div><em>데이터가 없습니다.</em></div>`;$(".redar_container").html(e),$(".data-loader").css("display","none")}function confirm_regist(t,e,s,i){ncuim_modal_show("등록하시겠습니까?",`do_regist('${t}', ${e}, ${s}, ${i});`)}function success_regist(t,e,s,i,l){let n=get_slot(t,e,s);if(!n)return;regist||(regist={uid:0,regist_list:[]});let o;for(var a=0;a<regist.regist_list.length;a++)regist.regist_list[a].category==t&&regist.regist_list[a].section_id==e&&(o=regist.regist_list[a]);o||(o={category:t,section_id:e,slot_list:[],is_complete:!1},regist.regist_list.push(o)),o.slot_list.push(n),l&&(o.is_complete=l);for(var a=0;a<inventory.length;a++){let c=inventory[a];c.id==i&&(c.amount==n.amount?inventory.splice(a,1):c.amount-=n.amount)}let r=$(".collection_section[data-category="+t+"][data-section-id="+e+"]"),d=r.find(".section_desc"),u=r.find(".slot_list .slot[data-slot-id="+s+"]");l&&d.append('<strong class="section_complete">완성</strong>'),u.children(".status.enable").remove();let g=`완성률(${current_size}/${total_size} ${Math.max(Math.min(parseInt(current_size/total_size*100),100),0)}%)`;$("header h1 span").text(g)}let registLock=!1;function do_regist(t,e,s,i){!registLock&&(registLock=!0,getDatasWithOption([{type:"POST",url:"/define/collection/regist",dataType:"json",contentType:"application/json",Accept:"application/json",data:{category:t,section_id:e,slot_id:s,id:i}}],l=>{switch(l){case 1:success_regist(t,e,s,i,!1);break;case 2:success_regist(t,e,s,i,!0);break;case 3:ncuim_modal_show("인게임에서 등록할 수 있습니다.");break;case 4:ncuim_modal_show("계정 정보를 찾을 수 없습니다.");break;case 5:ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");break;case 6:ncuim_modal_show("월드 내 캐릭터를 찾을 수 없습니다.");break;case 7:ncuim_modal_show("파라미터 유효성 검증에 실패하였습니다.");break;case 8:ncuim_modal_show("컬렉션 정보를 찾을 수 없습니다.");break;case 9:ncuim_modal_show("등록가능한 아이템을 찾을 수 없습니다.");break;case 10:ncuim_modal_show("이미 등록된 슬롯입니다.");break;case 11:ncuim_modal_show("이미 완성된 컬렉션입니다.");break;case 12:ncuim_modal_show("아이템 소모에 실패하였습니다.");break;default:ncuim_modal_show("등록에 실패하였습니다.")}registLock=!1},t=>{registLock=!1}))}