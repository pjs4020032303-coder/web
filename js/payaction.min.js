/*!
 * project : payaction
 * author : LINOFFICE
 * 후원
 */ let payaction_singleton=null,payaction_singletonEnforcer="singletonEnforcer",order;class Payaction{constructor(e){if(e!==payaction_singletonEnforcer)throw"Cannot--construct singleton";this.init()}static get instance(){return payaction_singleton||(payaction_singleton=new Payaction(payaction_singletonEnforcer)),payaction_singleton}init(){let e=this;if(e.is_rest_api_lock=!1,e.order_expire_interval=null,e.wrap=document.querySelector(".wrap"),e.container=document.querySelector(".container"),e.status_code={INIT:"주문접수",ORDER:"입금대기",MATCHED:"입금완료",EXCLUDED:"주문취소"},account&&account.termsAgree&&(order=order_list.find(e=>"INIT"===e.status||"ORDER"===e.status),e.order_list_btn=document.createElement("button"),e.order_list_btn.setAttribute("id","order_list_btn"),e.order_list_btn.textContent="주문 내역 보기",e.wrap.appendChild(e.order_list_btn),e.order_list_btn.addEventListener("click",a=>{e.order_list_open()})),order)switch(order.status){case"INIT":e.order_init();break;case"ORDER":e.matching_ready()}e.addEvents()}agree(){let e=this;if(!account){ncuim_modal_show("로그인 후 이용 가능합니다.");return}if(!e.agree_check.is(":checked")){ncuim_modal_show("약관동의 후 진행할 수 있습니다.");return}getDatas(["/define/payaction/agree"],a=>{a&&(ncuim_modal_show("약관 동의가 완료되었습니다."),e.container.innerHTML=a,account.termsAgree=!0,document.querySelector("#payaction_order").addEventListener("click",a=>{e.order()}))},e=>{throw Error("agree payaction.js Error")})}order(){let e=this;if(order){ncuim_modal_show("이미 주문이 진행중입니다.");return}let a=$("#chargeName").val();if(!a||!a.length){ncuim_modal_show("입금자명을 입력하세요.");return}let r=$("#chargeAmt").val();if(!r||!r.length){ncuim_modal_show("입금금액을 입력하세요.");return}let t=NCoinUtils.getChargeAmt();if(0==t||""==t){ncuim_modal_show("입금금액을 입력하세요.");return}if(order_amount_ration&&(t<order_amount_ration||t%order_amount_ration!=0)){ncuim_modal_show(`${commaAdd(order_amount_ration)}원 단위로 입력하셔야 합니다.`);return}if(!account){ncuim_modal_show("로그인 후 이용 가능합니다.");return}if(!account.firstChar){ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");return}!e.is_rest_api_lock&&(e.is_rest_api_lock=!0,$(".dimmed").css("display","block"),$("#send_delay").css("display","block"),getDatasWithOption([{type:"POST",url:"/define/payaction/order",dataType:"json",contentType:"application/json",Accept:"application/json",data:{billing_name:a,order_amount:r}}],a=>{switch($("#send_delay").css("display","none"),a.code){case 1:switch(order=a.order,order_list.unshift(order),order.status){case"INIT":e.order_init();break;case"ORDER":e.matching_ready()}break;case 2:ncuim_modal_show("후원시스템이 작동중이지 않습니다.");break;case 3:ncuim_modal_show("인게임에서 이용할 수 있습니다.");break;case 4:ncuim_modal_show("계정 정보를 찾을 수 없습니다.");break;case 5:ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");break;case 6:ncuim_modal_show("인게임 내 케릭터를 찾을 수 없습니다.");break;case 7:ncuim_modal_show("이미 주문이 진행중입니다.");break;case 8:ncuim_modal_show("파라미터가 누락되었습니다.");break;case 9:ncuim_modal_show("주문 정보 DB저장에 실패하였습니다.");break;case 10:ncuim_modal_show("주문은 접수하였으나 API통신에 실패하였습니다. 관리자에게 문의하십시오.");break;case 11:ncuim_modal_show(`${commaAdd(order_amount_ration)}원 단위로 주문하셔야 합니다.`);break;default:ncuim_modal_show("주문에 실패하였습니다.")}e.is_rest_api_lock=!1},a=>{$(".dimmed").css("display","none"),$("#send_delay").css("display","none"),e.is_rest_api_lock=!1,ncuim_modal_show("오류가 발생하였습니다.")}))}order_init(){ncuim_modal_show("주문이 접수되었습니다.<br/>관리자가 확인 후 입금계좌가 전송됩니다.");let e=`<div class="order_init"><span>주문이 접수되었습니다. 관리자가 확인 후 입금계좌가 전송됩니다.</span><button class="order_init_cancel_btn">접수취소</button></div>`;$("#support_content").append(e),document.querySelector(".order_init_cancel_btn").addEventListener("click",e=>{ncuim_modal_show("정말로 취소하시겠습니까?","Payaction.instance.order_cancel()")})}matching_ready(){let e=this;ncuim_modal_show("입금하실 계좌정보가 도착하였습니다. 확인 후 진행하십시오."),e.container.innerHTML=order.order_bank_tag,e.matching_timer(),document.querySelector(".order_cancel_btn").addEventListener("click",e=>{ncuim_modal_show("정말로 취소하시겠습니까?","Payaction.instance.order_cancel()")})}matching_complete(e){this.order_expire_interval&&clearInterval(this.order_expire_interval),ncuim_modal_show(e),order.status="MATCHED",$(".bank_desc").remove(),$(".order_expire").remove(),$(".order_cancel_btn").remove(),$(".bank_info .tit").text("정상적으로 후원이 완료되었습니다."),$(".bank_info .ex").text("※ 문제가 발생되었다면 주문번호를 관리자에게 문의바랍니다."),$(".order_info").append(`<div class="col"><span class="key">완료일시</span><span class="val">${moment().format("YY.MM.DD HH:mm:ss")}</span></div>`)}matching_exclude(){this.order_expire_interval&&clearInterval(this.order_expire_interval),ncuim_modal_show("주문시간이 만료되어 취소처리 되었습니다."),order.status="EXCLUDED",order.order_expire=0,$(".bank_desc").remove(),$(".order_expire").remove(),$(".order_cancel_btn").remove(),$(".bank_info .tit").text("주문시간이 만료되어 취소처리 되었습니다."),$(".bank_info .ex").text("※ 문제가 발생되었다면 주문번호를 관리자에게 문의바랍니다."),$(".order_info").append(`<div class="col"><span class="key">취소일시</span><span class="val">${moment().format("YY.MM.DD HH:mm:ss")}</span></div>`)}matching_timer(){let e=this,a=order&&order.order_expire?order.order_expire:0;if(!a)return;let r=Math.floor((a-new Date().getTime())/1e3);if(r<=0)return;let t=$(".order_expire .val");t.text(`${r} 초`),e.order_expire_interval=setInterval(function(){t.text(`${--r} 초`),r<=0&&e.matching_exclude()},1e3)}finish_close(){window.self.opener?window.self.close():history.back()}order_cancel(){let e=this;order&&order.order_number&&order.order_number.length&&!e.is_rest_api_lock&&(e.is_rest_api_lock=!0,$(".dimmed").css("display","block"),$("#send_delay").css("display","block"),getDatasWithOption([{type:"POST",url:"/define/payaction/ordercancel",dataType:"json",contentType:"application/json",Accept:"application/json",data:{order_number:order.order_number}}],a=>{switch($("#send_delay").css("display","none"),a){case 1:e.order_expire_interval&&clearInterval(e.order_expire_interval),$(".order_expire").remove(),ncuim_modal_show("정상적으로 취소되었습니다.",null,"Payaction.instance.finish_close()");break;case 2:ncuim_modal_show("후원시스템이 작동중이지 않습니다.");break;case 3:ncuim_modal_show("계정 정보를 찾을 수 없습니다.");break;case 4:ncuim_modal_show("대표 캐릭터를 찾을 수 없습니다.");break;case 5:ncuim_modal_show("진행중인 주문이 없습니다.");break;case 6:ncuim_modal_show("파라미터가 누락되었습니다.");break;case 7:ncuim_modal_show("주문정보가 올바르지 않습니다.");break;case 8:ncuim_modal_show("해당 주문은 취소 가능한 상태가 아닙니다.");break;case 9:ncuim_modal_show("API통신에 실패하였습니다. 관리자에게 문의하십시오.");break;default:ncuim_modal_show("취소에 실패하였습니다.")}e.is_rest_api_lock=!1},a=>{$(".dimmed").css("display","none"),$("#send_delay").css("display","none"),e.is_rest_api_lock=!1,ncuim_modal_show("오류가 발생하였습니다.")}))}order_list_open(){let e=this;if(!order_list||!order_list.length){ncuim_modal_show("주문 내역이 없습니다.");return}let a=order_list.map((a,r)=>`<li data-idx="${r}"><div class="list_item num"><span class="key">주문번호</span><span class="val">${a.order_number}</span></div><div class="list_item amount"><span class="key">주문금액</span><span class="val">${commaAdd(a.order_amount)} 원</span></div><div class="list_item date"><span class="key">주문일시</span><span class="val">${a.order_date}</span></div><div class="list_item name"><span class="key">주문자명</span><span class="val">${a.billing_name}</span></div><div class="list_item status"><span class="key">주문상태</span><span class="val">${e.status_code[a.status]}</span></div></li>`).join(""),r=document.createElement("div");r.setAttribute("id","order_list_container"),r.innerHTML=`<h1><i class="xi-list"></i>주문 내역</h1><div id="order_list"><ul>${a}</ul></div>`;let t=document.createElement("button");t.setAttribute("id","order_list_close_btn"),t.textContent="주문 내역 닫기",r.appendChild(t),e.wrap.appendChild(r),t.addEventListener("click",e=>{r.remove()})}chargeNameResetFade(){""==!$(".charge-name .chargeName").val()?$(".chargeName-reset").fadeIn():$(".chargeName-reset").fadeOut()}chargeAmtResetFade(){""==!$(".charge-value .chargeAmt").val()?$(".chargeAmt-reset").fadeIn():$(".chargeAmt-reset").fadeOut()}setChargeAmount(e){var a=$(".charge-value .chargeAmt"),r=NCoinUtils.formatCommas(e);a.val(r),this.show_unit()}show_unit(){var e=$(".chargeAmt").val().length,a=48;e>0?(5==e||6==e||7==e?(e-=1,a+=10):e>=9&&(e-=1,a),$(".show-unit").length||$(".charge-value .static .wrapper").append('<p class="show-unit"><span>원</span></p>'),$(".show-unit").css({left:a+11*e})):$(".show-unit").length&&$(".charge-value .static .wrapper .show-unit").remove()}addEvents(){let e=this;document.querySelector(".wrap header .btn_close").addEventListener("click",a=>{e.finish_close()}),account&&account.termsAgree?document.querySelector("#payaction_order").addEventListener("click",a=>{e.order()}):(e.agree_check=$("#agree_check"),document.querySelector("#payaction_agree").addEventListener("click",a=>{e.agree()})),$("#chargeAmt").on("keydown",function(a){let r=a.keyCode;if(17==r||18==r||!(r>=48&&r<=57||r>=96&&r<=105||8==r||9==r))return!1;var t=$(".charge-value .chargeAmt"),n=NCoinUtils.getChargeAmt(t.val());e.setChargeAmount(n)}),$("#chargeAmt").on("keyup",function(){var a=$(".charge-value .chargeAmt"),r=NCoinUtils.getChargeAmt(a.val());e.setChargeAmount(r)}),$(".charge-value .chargeAmt").on({focus:function(){$(this).parent().addClass("focus")},blur:function(){if(""==$(this).val())return $(this).parent().removeClass("focus"),$(".chargeAmt-reset").fadeOut(),!1;var a=$(".charge-value .chargeAmt"),r=NCoinUtils.getChargeAmt(a.val());e.setChargeAmount(r),e.chargeAmtResetFade()},keypress:function(){e.chargeAmtResetFade()}}),$("#chargeName").on("keyup",function(){e.chargeNameResetFade()}),$(document).on("click",".charge-value .chargeAmt-reset",function(){$(".chargeAmt").val("").focus();var a=$(".charge-value .chargeAmt"),r=NCoinUtils.getChargeAmt(a.val());e.setChargeAmount(r),$(".chargeAmt-reset").fadeOut()}),$(".charge-name .chargeName").on({focus:function(){$(this).parent().addClass("focus")},blur:function(){if(""==$(this).val())return $(this).parent().removeClass("focus"),$(".chargeName-reset").fadeOut(),!1;e.chargeNameResetFade()},keypress:function(){e.chargeNameResetFade()}}),$(document).on("click",".charge-name .chargeName-reset",function(){$(".chargeName").val("").focus(),$(".chargeName-reset").fadeOut()}),(ws_handler=new WebSocketHandler(ws_config,new PAYACTION_WEBSOCKET)).connect()}}class PAYACTION_WEBSOCKET{constructor(){}on_open(e){}on_message(e){let a=e.data;if(-1==a.indexOf("{")){console.log("not found protocol delimiter "+a);return}var r=JSON.parse(a);if(!r){console.log("not found protocol object "+a);return}if(account&&account.name&&r.user_name&&account.name==r.user_name)switch(r.type){case"PAYACTION_ORDER":let t=JSON.parse(r.message);order.order_expire=t.order_expire,order.order_bank_tag=t.order_bank_tag,order.status=t.status,Payaction.instance.matching_ready();break;case"PAYACTION_MATCHED":Payaction.instance.matching_complete(r.message)}}on_close(e){}}Payaction.instance;